# Excel文档合并工具软件设计文档

## 1. 需求分析

### 1.1 核心功能
- **文件导入管理**：支持多个Excel文件导入，避免重复导入，支持单独删除和重新导入
- **字段映射配置**：标准字段管理，各文件字段映射配置，映射规则保存
- **特殊规则处理**：自然语言规则解析，文件特定预处理规则
- **智能表头识别**：自动识别有效表头行，处理多表头情况
- **文件合并导出**：基于映射规则和特殊规则进行数据合并

### 1.2 业务规则
- 收入数据为正数，支出数据为负数
- 支持自然语言描述的特殊规则
- 映射配置和特殊规则分别保存为JSON文件
- 使用相对路径，Python实现

## 2. 系统架构设计

### 2.1 整体架构
```
Excel合并工具
├── 用户界面层 (UI Layer)
├── 业务逻辑层 (Business Logic Layer)
├── 数据处理层 (Data Processing Layer)
└── 文件操作层 (File Operation Layer)
```

### 2.2 模块设计

#### 2.2.1 用户界面模块 (ui_module)
- **类名**: `ExcelMergeUI`
- **方法**:
  - `__init__()`: 初始化界面
  - `create_main_window()`: 创建主窗口
  - `create_file_import_section()`: 创建文件导入区域
  - `create_field_mapping_section()`: 创建字段映射区域
  - `create_special_rules_section()`: 创建特殊规则区域
  - `create_merge_section()`: 创建合并操作区域
  - `show_message()`: 显示消息提示

#### 2.2.2 文件管理模块 (file_manager)
- **类名**: `FileManager`
- **方法**:
  - `import_excel_files()`: 导入Excel文件
  - `remove_file()`: 删除已导入文件
  - `reimport_file()`: 重新导入文件
  - `get_imported_files()`: 获取已导入文件列表
  - `validate_file()`: 验证文件格式
  - `get_file_columns()`: 获取文件列名

#### 2.2.3 字段映射模块 (field_mapping)
- **类名**: `FieldMappingManager`
- **方法**:
  - `add_standard_field()`: 添加标准字段
  - `remove_standard_field()`: 删除标准字段
  - `update_standard_field()`: 更新标准字段
  - `get_standard_fields()`: 获取标准字段列表
  - `set_file_mapping()`: 设置文件字段映射
  - `get_file_mapping()`: 获取文件字段映射
  - `save_mapping_rules()`: 保存映射规则到JSON
  - `load_mapping_rules()`: 从JSON加载映射规则
  - `validate_mapping()`: 验证映射配置

#### 2.2.4 特殊规则模块 (special_rules)
- **类名**: `SpecialRulesManager`
- **方法**:
  - `add_rule()`: 添加特殊规则
  - `remove_rule()`: 删除特殊规则
  - `update_rule()`: 更新特殊规则
  - `get_rules()`: 获取所有规则
  - `parse_natural_language_rule()`: 解析自然语言规则
  - `save_rules()`: 保存规则到JSON
  - `load_rules()`: 从JSON加载规则
  - `apply_rule()`: 应用规则到数据

#### 2.2.5 表头识别模块 (header_detection)
- **类名**: `HeaderDetector`
- **方法**:
  - `detect_header_row()`: 检测表头行
  - `identify_balance_columns()`: 识别余额相关列
  - `validate_header()`: 验证表头有效性
  - `get_valid_headers()`: 获取有效表头

#### 2.2.6 数据处理模块 (data_processor)
- **类名**: `DataProcessor`
- **方法**:
  - `preprocess_data()`: 数据预处理
  - `apply_field_mapping()`: 应用字段映射
  - `apply_special_rules()`: 应用特殊规则
  - `merge_data()`: 合并数据
  - `format_output_data()`: 格式化输出数据
  - `validate_merged_data()`: 验证合并后数据

#### 2.2.7 文件操作模块 (file_operations)
- **类名**: `FileOperations`
- **方法**:
  - `read_excel_file()`: 读取Excel文件
  - `write_excel_file()`: 写入Excel文件
  - `save_json_config()`: 保存JSON配置
  - `load_json_config()`: 加载JSON配置
  - `get_relative_path()`: 获取相对路径

#### 2.2.8 规则解析模块 (rule_parser)
- **类名**: `RuleParser`
- **方法**:
  - `parse_date_range_rule()`: 解析日期范围规则
  - `parse_balance_rule()`: 解析余额规则
  - `parse_income_expense_rule()`: 解析收支规则
  - `parse_page_break_rule()`: 解析分页符规则
  - `parse_header_rule()`: 解析表头规则
  - `extract_keywords()`: 提取关键词

#### 2.2.9 配置管理模块 (config_manager)
- **类名**: `ConfigManager`
- **方法**:
  - `save_mapping_config()`: 保存映射配置
  - `load_mapping_config()`: 加载映射配置
  - `save_rules_config()`: 保存规则配置
  - `load_rules_config()`: 加载规则配置
  - `get_config_path()`: 获取配置路径

#### 2.2.10 主控制器模块 (main_controller)
- **类名**: `ExcelMergeController`
- **方法**:
  - `__init__()`: 初始化控制器
  - `start_application()`: 启动应用程序
  - `handle_file_import()`: 处理文件导入
  - `handle_field_mapping()`: 处理字段映射
  - `handle_special_rules()`: 处理特殊规则
  - `handle_merge_operation()`: 处理合并操作
  - `validate_operation()`: 验证操作有效性

## 3. 数据流设计

### 3.1 文件导入流程
```
用户选择文件 → 文件验证 → 读取列名 → 更新文件列表 → 界面刷新
```

### 3.2 字段映射流程
```
选择标准字段 → 选择文件 → 设置映射关系 → 保存映射配置 → 验证映射
```

### 3.3 特殊规则流程
```
输入自然语言规则 → 规则解析 → 规则验证 → 保存规则配置 → 应用规则
```

### 3.4 合并导出流程
```
加载配置 → 读取文件 → 应用映射 → 应用特殊规则 → 合并数据 → 导出文件
```

## 4. 数据结构设计

### 4.1 文件信息结构
```python
FileInfo = {
    'file_path': str,
    'file_name': str,
    'columns': List[str],
    'header_row': int,
    'import_time': datetime
}
```

### 4.2 映射配置结构
```python
MappingConfig = {
    'standard_fields': List[str],
    'file_mappings': {
        'file_name': {
            'standard_field': 'source_column'
        }
    }
}
```

### 4.3 特殊规则结构
```python
SpecialRule = {
    'file_name': str,
    'rule_description': str,
    'rule_type': str,
    'rule_parameters': dict
}
```

## 5. 技术实现要点

### 5.1 依赖库
- `pandas`: Excel文件读写
- `tkinter`: 用户界面
- `json`: 配置文件处理
- `re`: 自然语言规则解析
- `datetime`: 时间处理

### 5.2 关键算法
- 表头识别算法：基于关键词匹配和数据结构分析
- 自然语言解析：基于关键词提取和规则模板匹配
- 数据合并算法：基于映射关系和特殊规则的数据转换

### 5.3 错误处理
- 文件格式验证
- 映射关系验证
- 规则解析错误处理
- 数据合并异常处理

## 6. 扩展性设计

### 6.1 规则引擎扩展
- 支持更多银行格式
- 支持自定义规则模板
- 支持规则组合和优先级

### 6.2 界面扩展
- 支持拖拽操作
- 支持批量操作
- 支持操作历史记录

### 6.3 数据处理扩展
- 支持更多数据格式
- 支持数据验证和清洗
- 支持数据统计和分析
